rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
             request.auth.token.email in [
               'jeromessenyonjo@gmail.com',
               'denis.omoding@watotochurch.com'
             ];
    }

    function attendanceOnlyIncrements() {
      let oldAttendance = resource.data.get('attendanceCount', 0);
      let newAttendance = request.resource.data.get('attendanceCount', oldAttendance);
      return newAttendance >= oldAttendance;
    }

    function isValidMorpherData() {
      return request.resource.data.keys().hasAll(['Name', 'MorphersNumber']) &&
             request.resource.data.Name is string &&
             request.resource.data.Name.size() >= 2 &&
             request.resource.data.MorphersNumber is string &&
             request.resource.data.MorphersNumber.size() >= 7 &&
             // Ensure firstTimeOn is valid if present (optional string)
             (!('firstTimeOn' in request.resource.data) || request.resource.data.firstTimeOn is string);
    }

    function isValidUpdate() {
      return request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly([
               'Name', 'MorphersNumber', 'MorphersCountryCode',
               'ParentsCountryCode', 'ParentsName', 'ParentsNumber',
               'School', 'Class', 'Residence', 'Cell', 'attendance',
               'attendanceCount', 'lastUpdated'
             ]);
    }

    match /morphers/{document} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isValidMorpherData();
      allow update: if isAuthenticated() && isValidUpdate() && attendanceOnlyIncrements();
      allow delete: if false;
    }

    match /admin_operations/{document} {
      allow read, write: if isAdmin();
    }

    match /config/{document} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /audit_logs/{document} {
      allow read, write: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
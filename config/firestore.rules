rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
             request.auth.token.email in [
               'jeromessenyonjo@gmail.com',
               'denis.omoding@watotochurch.com'
               // Add more admin emails as needed
             ];
    }

    function isValidMorpherData() {
      return request.resource.data.keys().hasAll(['Name', 'MorphersNumber']) &&
             request.resource.data.Name is string &&
             request.resource.data.Name.size() >= 2 &&
             request.resource.data.MorphersNumber is string &&
             request.resource.data.MorphersNumber.size() >= 7;
    }

    function isValidUpdate() {
      return request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly(['Name', 'MorphersNumber', 'ParentsName', 'ParentsNumber',
                      'School', 'Class', 'Residence', 'Cell', 'attendance', 'lastUpdated']);
    }

    // Main morphers collection rules
    match /morphers/{document} {

      // Allow read access for searching (public read for search functionality)
      allow read: if true;

      // Allow create for authenticated users with valid data
      allow create: if isAuthenticated() && isValidMorpherData();

      // Allow updates for authenticated users, with restrictions
      allow update: if isAuthenticated() && isValidUpdate();

      // Allow delete only for admins
      allow delete: if isAdmin();
    }

    // Admin-only operations collection (for bulk operations, logging, etc.)
    match /admin_operations/{document} {
      allow read, write: if isAdmin();
    }

    // System configuration (read-only for authenticated users)
    match /config/{document} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Audit logs (admin only)
    match /audit_logs/{document} {
      allow read, write: if isAdmin();
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}